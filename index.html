<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Home</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Home</h1>

    



    


    <h3> </h3>










    




    <section>
        <article><h1>Daisy SDK &amp; Docs</h1>
<h2>Install</h2>
<blockquote>
<p>You may also require some extra dependencies like <code>axios</code>, <code>web3</code>, <code>eventemitter3</code>, and <code>querystring</code>.</p>
</blockquote>
<pre class="prettyprint source lang-sh"><code>yarn add daisy-sdk axios eventemitter3 querystring web3@1.0.0-beta.37
</code></pre>
<h2>MetaMask helper</h2>
<p>To help you handle web3 instances and the current account we recommended <a href="https://github.com/daisypayments/react-metamask#readme">daisypayments/react-metamask</a>.</p>
<h2>Usage</h2>
<h3>1. Standard private and public plans with DaisySDK</h3>
<p>This is the default flow with standardized plans. This requires the implementation of a front-end with integration of Daisy Widget or Daisy SDK (advanced).</p>
<h4>1.1 Create a Subscription Product and Plans</h4>
<p>After deploying a Subscription Product to the blockchain go to the <em>API Integration</em> tab and get the <code>DAISY_ID</code> and <code>DAISY_SECRET_KEY</code>.</p>
<pre class="prettyprint source lang-txt"><code># Example values
DAISY_ID=margarita
DAISY_SECRET_KEY=key
</code></pre>
<h4>1.2 Integration in the server</h4>
<p>Create an instance of <code>ServiceSubscriptions</code> from the <code>daisy-sdk/private</code> sub-module.
It is extremely important to keep <code>DAISY_SECRET_KEY</code> <strong>private</strong>.</p>
<pre class="prettyprint source lang-js"><code>const { ServiceSubscriptions } = require(&quot;daisy-sdk/private&quot;);

const subscriptionService = new ServiceSubscriptions({
  identifier: process.env.DAISY_ID,
  secretKey: process.env.DAISY_SECRET_KEY,
});
</code></pre>
<p>Create and endpoint to retrieve information from your servers back to the frontend.
Here is an example using Express.js:</p>
<pre class="prettyprint source lang-js"><code>const express = require(&quot;express&quot;);
const h = require(&quot;express-async-handler&quot;);

const app = express();

// GET /api/plans/ -> Fetch plans from the frontend
app.get(&quot;/api/plans/&quot;, h(async (req, res) => {
  const { plans } = await subscriptionService.getData();
  res.json({ plans });
}));

// POST /api/plan/:pid/subscriptions/ -> Submit a subscription to Daisy
app.post(&quot;/api/plan/:pid/subscriptions/&quot;, h(async (req, res) => {
  const user = req.session;
  const { agreement, signature } = req.body;

  const { plans } = await subscriptionService.getData();
  const plan = plans.find(p => p[&quot;id&quot;] === req.params[&quot;pid&quot;]);
  if (!plan) {
    throw // ...
  }

  let authSignature = null; // not required for public plans.
  if (plan.private) {
    // TODO: Add conditions for `user` to use private plan.

    const authorizer = {
      privateKey: Buffer.from(process.env.PRIVATE_KEYS, &quot;hex&quot;),
    };
    authSignature = await subscriptionService.authorize(
      authorizer,
      agreement,
    );
  }

  const { data: subscription } = await subscriptionService.submit({
    agreement,
    authSignature,
    signature,
  });

  // Save and associate DaisyID from `subscription[&quot;daisyId&quot;]` to an user.
  const daisyId = subscription[&quot;daisyId&quot;];
  await user.patch({ daisyId });

  res.send(&quot;ok&quot;);
}));
</code></pre>
<h5>1.2.1 Get plans from the frontend (not recommended)</h5>
<p>This will only expose <code>private: false</code> plans.</p>
<pre class="prettyprint source lang-js"><code>import DaisySDK from &quot;daisy-sdk&quot;;

const daisy = new DaisySDK({ identifier: &quot;margarita&quot; }, web3)

const { plans } = await daisy.getData();
</code></pre>
<h4>1.3 Approving tokens</h4>
<p>It is required to approve tokens before signing the subscription agreement.</p>
<pre class="prettyprint source lang-js"><code>const daisy = new DaisySDK({ identifier: &quot;margarita&quot; }, web3)
await daisy.sync();

const token = daisy.loadToken(); // web3.js contract instance

const approvalAmount = &quot;9000000000000000&quot;;
const account = &quot;0x...&quot; // from MetaMask.

const eventemitter = daisy
  .prepareToken(token)
  .approve(approvalAmount, { from: account });

const eventemitter
  .on(&quot;transactionHash&quot;, handleApprove_transactionHash)
  .on(&quot;confirmation&quot;, handleApprove_confirmation)
  .on(&quot;receipt&quot;, handleApprove_receipt)
  .on(&quot;error&quot;, handleApprove_error);

function handleApprove_transactionHash(transactionHash) {
  // ...
};
function handleApprove_confirmation(confirmationNumber, receipt) {
  // ...
};
function handleApprove_receipt(receipt) {
  // Here you can assume this task is complete.
  // If you want to resume this transaction, save the `receipt` object.
};
function handleApprove_error(error) {
  // ...
};
</code></pre>
<h4>1.4 Signing subscription agreement</h4>
<pre class="prettyprint source lang-js"><code>const daisy = new DaisySDK({ identifier: &quot;margarita&quot; }, web3)
await daisy.sync();

const token = daisy.loadToken(); // web3.js contract instance

const { signature, agreement } = await daisy
  .prepareToken(token)
  .sign({ account, plan });

// Send `signature` and `agreement` back to the server
// TODO: replace `:pid` with Plan ID.
const response = await fetch(&quot;/api/plan/:pid/subscriptions/&quot;, {
  method: &quot;post&quot;,
  credentials: &quot;same-origin&quot;,
  body: JSON.stringify({ signature, agreement }),
});

const data = await response.json();
</code></pre>
<h5>1.4.1 Submit subscription from the frontend (only for public plans) (not recommended)</h5>
<pre class="prettyprint source lang-js"><code>const { data: subscription } = await daisy.submit({
  agreement,
  signature,
});
</code></pre>
<h4>1.5 Verify Daisy subscription state</h4>
<p>Verify subscription state with:</p>
<pre class="prettyprint source lang-js"><code>const subscription = await subscriptionService.getSubscription({
  id: daisyID,
});
console.log(subscription[&quot;state&quot;]);

const subscriptions = await subscriptionService.getSubscriptions({
  account: &quot;0x...&quot;,
});
</code></pre>
<h3>2. Invitations</h3>
<p>Daisy Invitation allows client to externalize the flow to Daisy's domain.</p>
<h4>2.1 Recommended usage: WebHooks</h4>
<p>Let's say you created a Daisy Invitation with the following id:</p>
<pre class="prettyprint source lang-txt"><code>identifier: &quot;/i/af4cff8c&quot;
callbackURL: https://myapp.com/api/callback/daisy-invitation/
callbackExtra: {}

</code></pre>
<p>Then we need to route <code>callbackURL</code> to your server URL (with HTTPS) and a path.
This route must handle a HTTP POST request and return a <code>2XX</code> status code.</p>
<pre class="prettyprint source lang-ts"><code>// TypeScript typing

type ID = string;

/**
 * JSON Payload attached to the POST request to `callbackURL`
 */
interface WebhookFromInvitation {
  /**
   * Semver string
   * Current version: 1.0.0
   */
  version: string;
  subscription: {
    /**
     * DaisyID
     */
    daisyId: ID;
  };
  plan: {
    id: ID;
    private: boolean;
  };
  invitation: {
    id: ID;
  };
  agreement: SubscriptionAgreement;
  extra: any;
}

// From Daisy SDK `sign` method.
interface SubscriptionAgreement = {
  /**
   * Subscriber Ethereum address
   */
  subscriber: string;
  /**
   * Token address
   */
  token: string;
  amount: string;
  periodUnit: string;
  periods: string;
  maxExecutions: string;
  signatureExpiresAt: string;
  plan: string;
  nonce: string;
}
</code></pre>
<p>So a normal server should handle this POST request like:</p>
<pre class="prettyprint source lang-js"><code>const express = require(&quot;express&quot;);
const h = require(&quot;express-async-handler&quot;);

const app = express();

// GET /api/callback/daisy-invitation/ -> Daisy callback handler
app.get(&quot;/api/callback/daisy-invitation/&quot;, h(async (req, res) => {
  const { subscription, plan } = req.body

  // TODO: Identify the user
  await user.patch({ daisyID: subscription[&quot;daisyId&quot;] });

  let authSignature = null; // not required for public plans.
  if (plan.private) {
    // TODO: Add conditions for user to use private plan.

    const authorizer = {
      privateKey: Buffer.from(process.env.PRIVATE_KEYS, &quot;hex&quot;),
    };
    authSignature = await subscriptionService.authorize(
      authorizer,
      agreement,
    );
  }

  // Optional redirect URL, may have custom tokens.
  // Is not guaranteed the user is going to enter this URL.
  const redirectURL = &quot;https://myapp.com/checkount/finish/&quot;;

  res.json({ authSignature, redirectURL })
}));
</code></pre>
<h4>2.2 Identifying the user</h4>
<p>One way to identify an user after getting the callback is by knowing before-hand the user's Ethereum address.
So it can be queried from <code>req.body[&quot;agreement&quot;][&quot;subscriber&quot;]</code></p>
<p>A better way is setting the <code>callbackExtra</code> payload to something we can recognize in the backend.
Example:</p>
<pre class="prettyprint source lang-language"><code>identifier: &quot;/i/af4cff8c&quot;
callbackURL: https://myapp.com/api/callback/daisy-invitation/
callbackExtra: { &quot;email&quot;: &quot;user@daisypayments.com&quot; }
</code></pre>
<pre class="prettyprint source lang-js"><code>// GET /api/callback/daisy-invitation/ -> Daisy callback handler
app.get(&quot;/api/callback/daisy-invitation/&quot;, h(async (req, res) => {
  const { subscription, plan, extra } = req.body

  // TODO: Identify the user
  await user.findById({ email: extra[&quot;email&quot;] }).patch({ daisyId: subscription[&quot;daisyId&quot;] });

  // ...

  const redirectURL = `https://myapp.com/checkount/finish/?user=${user.id}`;

  res.json({ authSignature, redirectURL })
}
</code></pre></article>
    </section>






</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-browser.html">browser</a></li><li><a href="module-common.html">common</a></li><li><a href="module-private.html">private</a></li></ul><h3>Externals</h3><ul><li><a href="external-_web3.eth.Contract_.html">web3.eth.Contract</a></li><li><a href="external-PromiEvent.html">PromiEvent</a></li></ul><h3>Classes</h3><ul><li><a href="module-browser-DaisySDK.html">DaisySDK</a></li><li><a href="module-common-Client.html">Client</a></li><li><a href="module-common-SubscriptionProductClient.html">SubscriptionProductClient</a></li><li><a href="module-private-ServiceSubscriptions.html">ServiceSubscriptions</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.2</a> on Wed Jul 03 2019 09:33:23 GMT-0500 (Central Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>